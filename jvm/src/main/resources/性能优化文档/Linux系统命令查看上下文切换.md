### Linux 命令行工具之 vmstat 命令

vmstat 是一款指定采样周期和次数的功能性监测工具，可以使用它监控进程上下文切换的情况。

$ vmstat 1 3 

上述命令行代表每秒收集一次性能指标，总共获取 3次。以下为上图中各个性能指标的注释：
```
proc
sr：等待运行的进程数
b：处于非中断睡眠状态的进程数
memory
swpd：虚拟内存使用情况
free：空闲的内存
buff：用来作为缓冲的内存数
cache：缓存大小
swap
si：从磁盘交换到内存的交换页数量
so：从内存交换到磁盘的交换页数量
io
bi：发送到快设备的块数
bo：从块设备接收到的块数
system
in：每秒中断数
cs：每秒上下文切换次数
cpu
us：用户 CPU 使用事件
sy：内核 CPU 系统使用时间
id：空闲时间
wa：等待 I/O 时间
st：运行虚拟机窃取的时间
```

### Linux 命令行工具之 pidstat 命令

pidstat 命令就可以监测到具体线程的上下文切换，pidstat 是 Sysstat 中一个组件，也是一款功能强大的性能监测工具。我们可以通过命令 yum install sysstat 安装该监控组件。

通过 pidstat -help 命令，可以查看到有以下几个常用参数可以监测线程的性能：

```
常用参数：
-u：默认参数，显示各个进程的 cpu 使用情况；
-r：显示各个进程的内存使用情况；
-d：显示各个进程的 I/O 使用情况；
-w：显示每个进程的上下文切换情况；
-p：指定进程号；
-t：显示进程中线程的统计信息；
```

pidstat -w -p pid 命令行，可以查看到某个进程的上下文切换
```
cswch/s：每秒主动任务上下文切换数量
nvcswch/s：每秒被动任务上下文切换数量
```

pidstat -w -p pid -t 命令行，可以查看到具体线程的上下文切换

### JDK 工具之 jstack 命令

查看具体线程的上下文切换异常，还可以使用 jstack 命令查看线程堆栈的运行情况，jstack 是 JDK 自带的线程堆栈分析工具，使用该命令可以查看或导出 Java 应用程序中的线程堆栈信息。

jstack 最常用的功能就是使用 jstack pid 命令查看线程堆栈信息，通常是结合 pidstat -p pid -t 一起查看具体线程的状态，也经常用来排查一些死锁的异常。

每个线程堆栈的信息中，都可以查看到线程 ID、线程状态（wait、sleep、running 等状态）以及是否持有锁等。

可以通过 jstack 16079 > /usr/dump 将线程堆栈信息日志 dump 下来，之后打开 dump 文件，通过查看线程的状态变化，就可以找出导致上下文切换异常的具体原因。例如，系统出现了大量处于 BLOCKED 状态的线程，我们就需要立刻分析代码找出原因。


































