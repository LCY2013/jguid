### 性能调优三步走(测试、分析、调优)
```
影响性能的因数
1、IO
2、磁盘
3、CPU
4、网络
5、数据库
6、内存
...

系统负载：
    系统负载指的是在某一个时间段内的系统所有的进程或者线程数量(包括等待和运行中的)。
        
CPU利用率：
    系统运行中CPU核被某一个线程具体使用的情况。

当用户应用是CPU密集型的时候，可能CPU利用率会非常高，但是系统负载却非常低。

当用户应用是IO密集型的时候，可能系统负载会非常高，但是CPU利用率却非常低。

TCP应用问题排查思路
    利用 tcpdump 工具抓取网络包
    三次握手(每个过程)、四次挥手(每个过程)

数据库性能问题排查解决思路
    慢sql问题查看
    索引是否设置，索引是否命中，数据量是否太大
    数据库读写分离
    最后才是读写分离
    大数据中心进行数据的流处理，产生不同的业务数据
```

### 性能测试
```
1. 微基准性能测试
    微基准性能测试可以精准定位到某个模块或者某个方法的性能问题，
    特别适合做一个功能模块或者一个方法在不同实现方式下的性能对比。
    例如，对比一个方法使用同步实现和非同步实现的性能。

2. 宏基准性能测试
    宏基准性能测试是一个综合测试，需要考虑到测试环境、测试场景和测试目标。
    首先看测试环境，我们需要模拟线上的真实环境，然后看测试场景。
    我们需要确定在测试某个接口时，是否有其他业务接口同时也在平行运行，造成干扰，如果有，请重视，因为你一旦忽视了这种干扰，测试结果就会出现偏差。
    最后看测试目标，我们的性能测试是要有目标的，这里可以通过吞吐量以及响应时间来衡量系统是否达标。
    不达标，就进行优化，达标，就继续加大测试的并发数，探底接口的TPS（最大每秒事务处理量），这样做，可以深入了解到接口的性能。
    除了测试接口的吞吐量和响应时间以外，我们还需要循环测试可能导致性能问题的接口，观察各个服务器的CPU、内存以及 I/O 使用率的变化。

以上就是两种测试方法中值得注意的是，性能测试存在干扰因子，会使测试结果不准确。

java程序可能存在的影响因子:
    1、热身问题:
        jvm平台存在一个2-8原则，它讲的是在jvm应用启动的时候，它首先通过class字节码的解释执行，
        然后根据某些class的访问频率界定它属于热点代码块(20%)，然后通过JIT(即时编译)将class直接编译成机器码，
        然后保存在本地内存中，下次直接通过内存获取该机器码执行，提升执行效率。
    2、同一个平台存在多个JVM平台
        如果一个测试平台存在多个JVM，那么用不同的JVM就会造成不同的测试结果，所以尽量保持测试平台的所有外部条件一致，保证测试的准确性。
    3、同一个执行过程，存在哪一个时刻不同的GC行为
        尽量统一JVM GC相关参数信息，保证GC行为尽可能一致。
```

### 调优策略
```
1、优化代码
    比如业务代码中 LinkedList 遍历操作使用迭代器，而不是用for循环。

2、优化设计
    利用设计模式，优化业务代码和中间代码，精简代码等。

3、优化关键位置的算法结构
    往往不同的业务场景下都有对应的一些合适的算法或者数据结构，通过优化关键位置的算法和数据结构可以更大程度提高系统性能。

4、时间换空间
    有些场景下，时延可以被一定程度容忍，这个时候可以利用时间换空间。比如：java中的java.lang.String.intern()，利用复用同一个字符串达到换取空间的目的。

5、空间换时间 
    有些场景下，对时延要求比较高，这个时候可以考虑空间换取时间。比如：各种缓存服务

6、参数调优
    根据业务场景，合理地设置 JVM 的内存空间以及垃圾回收算法可以提升系统性能。
    比如业务中存在经常分配大对象的情况，就需要进行大对象的jvm参数设置，当分配的对象大于某一个阀值时，直接进入老年代，
        避免yang GC(Minor GC)频繁的消耗CPU，损耗系统性能。
        Web 容器线程池的设置以及 Linux 操作系统的内核参数设置不合理也有可能导致系统性能瓶颈。  
```

### 兜底策略
```
1、限流
    对系统的入口设置最大访问限制，可以参考性能测试中探底接口的 TPS，同时采取熔断措施，友好地返回没有成功的请求。

2、智能化横行扩展
    智能化横向扩容可以保证当访问量超过某一个阈值时，系统可以根据需求自动横向新增服务。

3、提前扩容
    这种方法通常应用于高并发系统。例如，瞬时抢购业务系统，这是因为横向扩容无法满足大量发生在瞬间的请求，即使成功了，抢购也结束了。

k8s + docker 组合

限流可以利用k8s ingress策略

智能横行扩展可以利用k8s设置的阀值
```
























